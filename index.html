<!doctype html>
<html>
<head>
        <script>
        // Apply theme from localStorage or system before page renders
        (function() {
            try {
                var theme = localStorage.getItem('site-theme');
                if (theme === 'light' || theme === 'dark') {
                    document.documentElement.setAttribute('data-theme', theme);
                } else {
                    document.documentElement.removeAttribute('data-theme');
                }
                    // Apply language from localStorage
                    var lang = localStorage.getItem('site-language');
                    if (lang) {
                        document.documentElement.setAttribute('lang', lang);
                    }
            } catch (e) {}
        })();
            // Listen for theme changes in other tabs
            window.addEventListener('storage', function(e) {
                if (e.key === 'site-theme') {
                    var theme = e.newValue;
                    if (theme === 'light' || theme === 'dark') {
                        document.documentElement.setAttribute('data-theme', theme);
                    } else {
                        document.documentElement.removeAttribute('data-theme');
                    }
                } else if (e.key === 'site-language') {
                    var lang = e.newValue;
                    if (lang) {
                        document.documentElement.setAttribute('lang', lang);
                    }
                }
            });
        </script>
    <meta charset="utf-8" />
    <title>Email check</title>
</head>
<body>
    <form id="checkForm">
        <input type="email" id="email" placeholder="you@gmail.com" required />
        <button type="submit">Submit</button>
    </form>

    <script>
        document.getElementById('checkForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const email = document.getElementById('email').value.trim().toLowerCase();
            if (!email) return;

            try {
                // Try to get signed-in Google account email (replace CLIENT_ID below)
                // File location: assets/txt/emails.txt
                // This uses Google Identity Services; create an OAuth client ID and replace the placeholder.
                await new Promise((res) => {
                    if (window.google && google.accounts && google.accounts.id) return res();
                    const s = document.createElement('script');
                    s.src = 'https://accounts.google.com/gsi/client';
                    s.onload = res;
                    s.onerror = res; // continue as guest if library can't be loaded
                    document.head.appendChild(s);
                });

                // attempt to get an ID token silently / auto-select if possible
                let loggedEmail = null;
                if (window.google && google.accounts && google.accounts.id) {
                    loggedEmail = await new Promise((resolve) => {
                        let done = false;
                        google.accounts.id.initialize({
                            client_id: 'REPLACE_WITH_YOUR_OAUTH_CLIENT_ID.apps.googleusercontent.com',
                            callback: (resp) => {
                                try {
                                    const payload = JSON.parse(atob(resp.credential.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
                                    resolve((payload.email || '').toLowerCase());
                                } catch (e) {
                                    resolve(null);
                                }
                                done = true;
                            },
                            auto_select: true,
                            cancel_on_tap_outside: true
                        });
                        // prompt may auto-sign if possible; wait briefly for callback
                        google.accounts.id.prompt();
                        setTimeout(() => { if (!done) resolve(null); }, 1500);
                    });
                }

                if (!loggedEmail) {
                    // not signed in -> guest
                    window.location.href = 'guest.html';
                    return;
                }

                // now check the email list
                const resp = await fetch('assets/txt/emails.txt', { cache: 'no-store' });
                if (!resp.ok) throw new Error('Could not load email list');
                const text = await resp.text();
                const list = text.split(/\r?\n/).map(s => s.trim().toLowerCase()).filter(Boolean);

                // prefer logged-in Google email if available, otherwise use the manually entered email
                const checkEmail = loggedEmail || email;
                if (list.includes(checkEmail)) {
                    window.location.href = 'admin.html';
                } else {
                    window.location.href = 'guest.html';
                }
            } catch (err) {
                console.error(err);
                alert('Error checking email. Make sure emails.txt is reachable (must be served from a web server).');
            }
        });
    </script>
</body>
</html>